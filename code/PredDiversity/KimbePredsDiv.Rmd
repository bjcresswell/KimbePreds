---
title: "Kimbe Bay Coral Reef Predator \n Fish Diversity Analysis"
author: "Ben Cresswell"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
 html_document:
    code_folding: show
    collapse: no
    df_print: paged
    fig_caption: yes
    fig_height: 6
    fig_width: 10
    highlight: textmate
    theme: spacelab
    toc: yes
    toc_float: yes
editor_options: 
  chunk_output_type: inline
---

Rmd created: 2.7.2021
Last edit: 31 Aug 2021 BJC
Last edit: 26 Oct 2021 BJC


# Introduction
This document analyses predator fish community diversity from the Kimbe Bay video survey data set.
Analyses are broken down into 2 broad components:

1. Diversity metrics (dealt with in the first part of this Rmd)
- This part models the effect of the predictor variable (reeftype) against 2 diversity metrics: Species richness and Shannon Weiner H (Simpsons excluded for reasons outline in div-diw script)

2. Community analysis (second part of this Rmd but also see venndiag, taxa_nos, ordiplot and mvabund scripts)
- This component investigates differences in community structure between the 3 reef types using a multivariate GLM, with PIT resampling to account for variance from random effect of site. Differences are visualised in a PCA and venn diagram.


```{r setup, include=FALSE, warnings=FALSE, message=FALSE}
# Rmd setup, directory selection
knitr::opts_chunk$set(root.dir = "~/OneDrive - James Cook University/Ben PhD/Data & analysis/KimbePreds/code/PredDiversity", echo = TRUE)
getwd()
```


# Packages and housekeeping
```{r div-packages,echo=TRUE, include=FALSE, eval=TRUE}
rm(list=ls())
library(gridExtra) #for plotting
library(writexl)
library(gt)
library(lme4)      #basic model builder
library(car)       #for regression diagnostics
library(multcomp)  #for lm work
library(broom)     #for tidy output
library(ggfortify) #for model diagnostics
library(DHARMa)    #for residual diagnostics
library(performance)
library(glmmTMB)   #for wider selection of error families
library(sjPlot)    #for outputs
library(effects)   #for partial effects plots
library(ggeffects) #for partial effects plots
library(emmeans)   #for estimating marginal means
library(modelr)    #for auxillary modelling functions
library(artyfarty) #for plotting
library(vegan)
library(MuMIn)     #for pseudo R2
library(tidyverse) #for data wrangling
```


# Data import and wrangling {.tabset .tabset-faded}

## Diversity data wrangling script
Generates a master-diversity data frame which includes diversity metrics and a species matrix
```{r pred-div-diw, warning=FALSE, include=FALSE, echo=TRUE}
source("pred_div_diw.R", local = knitr::knit_global())
```


# 1. Species Richness

# Basic data exploration {.tabset .tabset-faded}

## Data overview

Check how the data are distributed across the different reefs and reef types
```{r div-eda}
# Histogram
srhist <- ggplot(preddiv, aes(x=SpecNo)) + 
  geom_histogram(binwidth=1, color="black", fill="grey") # Count data and looks poisson distributed

# Boxplot - by reeftype
srbox <- ggplot(preddiv, aes(x=Reeftype, y=SpecNo))+
  geom_boxplot()

grid.arrange(srhist, srbox, ncol=2)
```
- Count data: will start with Poisson and move to neg binom if doesn't work

## Random effects
- Investigate random effects (added post ML course Oct 2021) (Note: AIC comparison with fixed effect models included below)
```{r rich-RE-plot}
# Check if random intercept/slope necessary for model
ggplot(preddiv, aes(y=SpecNo, x=SurvCode, group=Site_Tran)) +
    geom_point() +
    geom_line() +
    facet_grid(~Reeftype) # facet_wrap tried to make a square

```


#  Fit model {.tabset .tabset-faded}

## Poisson and Neg binom
Start with Poisson and Neg binom (Notes: REML=F returned better AIC by 5 points. ZI test good on both so no ZI term in formulae)
```{r rich-model-fit}
# Poisson
prglmmp <- glmmTMB(SpecNo ~ Reeftype+(1|Site), data = preddiv, family='poisson', REML = FALSE)
# Neg binom
prglmmnb <- glmmTMB(SpecNo ~ Reeftype+(1|Site), data = preddiv, family='nbinom2', REML = FALSE)

```

## DHARMa residuals
```{r rich-model-diag}
# Poisson
simulateResiduals(prglmmp, plot=T) # Looks good
testZeroInflation(prglmmp) # No ZI

# Neg binom
simulateResiduals(prglmmnb, plot=T) # Looks good
testZeroInflation(prglmmnb) # No ZI
```
- Residuals for both models look ok.

## AIC
```{r rich-model-aic}
AIC(prglmmp, prglmmnb)
```
- Poisson best fit - now compare to random effects only

## Random effects only
```{r raneffect-only}
# RE only
prglmmREn = glmmTMB(SpecNo ~ 1 + (1|Site), data = preddiv, family='gaussian', REML = FALSE)
prglmmREp = glmmTMB(SpecNo ~ 1 + (1|Site), data = preddiv, family='poisson', REML = FALSE)
```
## AIC2
```{r rich-model-aic2}
AIC(prglmmp, prglmmnb, prglmmREn, prglmmREp)
```
Poisson best fit overall

# Model investigation {.tabset .tabset-faded}

## Partial plot
```{r rich-partial-plot}
prglmmp %>% plot_model(type='eff', show.data=TRUE)
```

## Summary table
```{r rich-model-summary}
summary(prglmmp)
```
$ Summary Interpretation $

$ Pinnacles (Intercept) $
exp(1.7940)
->  mean of 6.01 spp per transect for pinnacle reefs

$ Offshore $
exp(-1.1626) = 0.3126722
0.313*6.01
-> mean of 1.88 spp per transect for offshore reefs

$ Nearshore $
exp(-1.7514) = 0.1735308
0.174*6.01
-> mean of 1.05 spp per transect for nearshore reefs

Variance in conditional model looks low but cbeck R2:

## R squared
```{r rich-model-R2}
r.squaredGLMM(prglmmp) # See ML section on this glmm_example1.Rmd - hard to interpret variance of random factors in GLMM
prglmmp %>% performance::r2_nakagawa()
```
-> Can also check random effects individually:

## Raneffects
```{r rich-model-raneffects}
prglmmp %>% ranef()
```

# Results {.tabset .tabset-faded}

## emmeans
```{r rich-emmeans-trans}
emmeans(prglmmp, pairwise~Reeftype, transform="response") %>% 
  confint() %>% 
  as.data.frame() %>% 
  tab_df() #tab_df for export
  
# OR from ML2021:
prglmmnb %>% 
  emmeans(~Reeftype) %>% 
  regrid %>% 
  pairs() %>% 
  summary(infer=TRUE)
```
$ emmeans notes $
- "Rate" is the reported term for a Poisson model (it's "response" for nb)
- Results from neg binom very similar


## Contrasts
```{r rich-emmeans-results}
# Need to convert to a tibble in the process to change the names of the contrasts (for plotting later):
richcontrasts <- emmeans(prglmmp, pairwise ~ Reeftype, transform='response') %>%
  confint() %>% 
  as.data.frame()

# pvalues
richpvals <- emmeans(prglmmp,  ~ Reeftype, transform='response', combine=TRUE) %>% 
  pairs() %>% 
  as.data.frame() 
  
# Combine for full results table
richresults <- bind_cols(richcontrasts, richpvals[5:6]) 

# Write to csv
write_csv(richresults, file = "../../output/rtables/richresults.csv")

# Copy to html
richresults %>% 
  tab_df(file="../../output/rtables/richresults.html", title = "Species richness contrasts (estimates)") #%>% 

# Display inline
richresults
```

## Ratios
```{r rich-emmeans-ratios}
richratios <- emmeans(prglmmp, pairwise ~ Reeftype, type='response') %>%
  confint() %>% 
  as.data.frame() 

# p values
richratiospvals <- emmeans(prglmmp,  ~ Reeftype, type='response', combine=TRUE) %>% 
  pairs() %>% 
  as.data.frame() 

# Combine
richratios <- bind_cols(richratios, richratiospvals[6:7]) 

# Write to csv
write_csv(richratios, file = "../../output/rtables/richratios.csv")

# Copy to html 
richratios %>% 
  tab_df(file="../../output/rtables/richratios.html", title = "Abundance contrasts (ratios)")
richratios
```


## Data for plotting
```{r rich-plots}
richplotdata <- emmeans(prglmmp, pairwise ~ Reeftype, transform='response') %>%
  confint() %>% 
  as_tibble() 

#save(richplotdata, file='../../data/richplotdata.RData')

```




#############################


# 2. Shannon H' Diversity

# Basic data exploration {.tabset .tabset-faded}

## Data overview
```{r shannon-eda}
# Shannon
shhist <- ggplot(preddiv, aes(x=Shannon)) + 
  geom_histogram(binwidth=0.1, color="black", fill="grey") # Possibly bimodal??
# Simpson - not used, see notes elsewhere
#sihist <- ggplot(data=subset(preddiv, Reeftype=='Nearshore'), aes(x=Simpson)) + 
#  geom_histogram(binwidth=0.1, color="black", fill="grey") # No idea...

shbox <- ggplot(preddiv, aes(x=Reeftype, y=Shannon))+
  geom_boxplot()

# Plot together
grid.arrange(shhist, shbox, ncol=2)
```

## Random effects

- Investigate random effects (added post ML course Oct 2021) (Note: AIC comparison with fixed effect models included below)
```{r shan-RE-plot}
# Check if random intercept/slope necessary for model
ggplot(preddiv, aes(y=Shannon, x=SurvCode, group=Site_Tran)) +
    geom_point() +
    geom_line() +
    facet_grid(~Reeftype) # facet_wrap tried to make a square

```

-> A note on error distributions
- Looks like it might be very zero-inflated so likely will need a ZI term to handle
- Can't use Poisson or Neg Binom as these are not count data
- In addition most error distributions won't work with these data including:
- Gamma - has to be positive values (and very bad residuals when using on raw data + 0.0000001)
- ziGamma - same
- Beta - has to be  0 < y < 1
- Binom - y values must be 0 <= y <= 1
- Inverse gaussian - positive values only and wouldn't work on ShannonAdj
- All quasi families
- All truncated families
So.. two remaining candidates are gaussian and tweedie


# Fit model {.tabset .tabset-faded}

Will use gaussian and tweedie distributions and check.


## Gaussian and Tweedie 
```{r shan-fitmodel}
# Gaussian (trying post ML2021)
set.seed(123)
pshan.glmm <- glmmTMB(Shannon ~ Reeftype+(1|Site), data = preddiv, family=gaussian(), ziformula = ~0,  REML = FALSE)
pshan.glmmT <- glmmTMB(Shannon ~ Reeftype+(1|Site), data = preddiv, family=tweedie(link = 'log'), ziformula = ~0, REML = FALSE)
```


## AIC 
```{r shan-model-aic}
AIC(pshan.glmm, pshan.glmmT)
```

-> Gaussian better AIC score but let's do the other diagnostics...


## DHARMa residuals
```{r checkdharma}
simulateResiduals(pshan.glmm, plot=TRUE) # Fails deviation and hv and QQ plot looks bad.
simulateResiduals(pshan.glmmT, plot=TRUE) # Fails dispersion and hv but QQ plot looks good. Check ZI...
```

## ZI test
-> Discarded the gaussian model so just for tweedie
```{r shan-zit}
testZeroInflation(pshan.glmmT)
```
-> Slightly under-dispersed



## Random effects only
```{r shan-re-check}
pshan.glmmRE = glmmTMB(Shannon ~ 1 + (1|Site), data = preddiv, family='tweedie', REML = FALSE)
```


##  AIC with RE
```{r shan-model-aicRE}
AIC(pshan.glmmT, pshan.glmmRE)
```
-> Full model outperforms RE-only model




# Model investigation {.tabset .tabset-faded}


## Partial plot
```{r shan-partial-plot}
pshan.glmmT %>% plot_model(type='eff', show.data=TRUE)
```




## Summary table
```{r shan-model-summary}
summary(pshan.glmmT)
```

$ Summary Interpretation $

$ Pinnacles (Intercept) $
exp(0.2143) = 1.238994
->  mean of 1.24 spp per transect for pinnacle reefs

$ Offshore $
exp(-0.9082) = 0.4032494
0.4*1.24 = 0.496
-> mean of 0.5 spp per transect for offshore reefs

$ Nearshore $
exp(-1.5133) = 0.2201822
0.22*1.24 = 0.2728
-> mean of 0.23 spp per transect for nearshore reefs

Variance in conditional model very low


## Raneffects
```{r shan-model-raneffects}
pshan.glmmT %>% ranef()
```



# Results {.tabset}

## emmeans
Calculate estimated marginal means of Shannon diversity index per reef type:
```{r shan-emmeans}
emmeans(pshan.glmmT, ~Reeftype, transform="response") %>% 
  #confint() #%>% 
  as.tibble() #%>% 
  #tab_df() #tab_df for HTML export
```


## Contrasts
Calculate pairwise contrasts between reef types (including 95% CI and Pvals)
```{r shan-contrasts}
pshan.glmmT %>% 
  emmeans(~Reeftype) %>% 
  regrid %>% 
  pairs() %>% 
  summary(infer=TRUE)
```

```{r shan-emmeans-otherways, eval=FALSE, include=FALSE, echo=FALSE, warning=FALSE, cache=FALSE, message=FALSE}
# emmeans and contrasts first
pshan.glmmT %>% 
  emmeans(pairwise ~ Reeftype, transform='response') %>%
  confint() %>% 
  as.data.frame() 

# pvalues
#emmeans(pshan.glmmT,  ~ Reeftype, transform='response', combine=TRUE) %>% 
#  pairs() %>% 
#  confint() %>% 
#  as.data.frame() 

# Combine for full results table
shanresults <- bind_cols(shancontrasts, shanpvals[5:6]) 

# Write to csv
#write_csv(shanresults, file = "../../output/rtables/shanresults.csv")

# Copy to html
#shanresults %>% 
#  tab_df(file="../../output/rtables/shanresultsTweedieREMLFALSE.html", title = "shandance contrasts (estimates)") #%>% 

# Display inline
#shanresults

```

## Ratios
Calculate pairwise contrasts on ratio scale (inc 95% CI and Pvals)
```{r shan-emmeans-ratios}

pshan.glmmT %>% 
  emmeans(~Reeftype, type='response') %>% 
  pairs() %>% 
  summary(infer=TRUE) 

# Ratios with CI
#emmeans(pshan.glmmT, pairwise ~ Reeftype, type='response') %>%
#  confint() %>% 
#  as.data.frame()

# p values
#shanratiopvals <- emmeans(pshan.glmmT,  ~ Reeftype, type='response', combine=TRUE) %>% 
#  pairs() %>% 
#  as.data.frame() 

# Combine
#shanratios <- bind_cols(shanratios, shanratiopvals[6:7]) 

# Write to csv
#write_csv(shanratios, file = "../../output/rtables/shanratios.csv")

# Copy to html 
#shanratios %>% 
#  tab_df(file="../../output/rtables/shanratios.html", title = "shandance contrasts (ratios)")
#shanratios
```


# Create plot data
```{r shan-plot-data}
# First calculate the emmeans estimates
shanplotmeans <- emmeans(pshan.glmmT, pairwise ~ Reeftype, transform='response') %>% 
  confint() %>% 
  as_tibble() %>% 
  #dplyr::select(-contrasts) %>% 
  transmute(Reeftype = emmeans$Reeftype,
            Mean = emmeans$response,
            DF = emmeans$df,
            MeanLowerCI95 = emmeans$lower.CL,
            MeanUpperCI95 = emmeans$upper.CL
            )

# Then the 66% confidence intervals
CI66 <- emmeans(pshan.glmmT, pairwise ~ Reeftype, transform='response') %>%
  confint(level = 0.66) %>% 
  as_tibble() %>% 
  transmute(contrastlowerCI66 = contrasts$lower.CL,
            contrastupperCI66 = contrasts$upper.CL)

# And bind to the 95% CI contrasts 
shanplotcontrasts <- emmeans(pshan.glmmT, pairwise ~ Reeftype, transform='response') %>%
  confint() %>% 
  as_tibble() %>% 
  transmute(
    Contrast = contrasts$contrast, 
    Estimate = contrasts$estimate, 
    contrastlowerCI95 = contrasts$lower.CL,
    contrastupperCI95 = contrasts$upper.CL
         ) %>% 
  bind_cols(CI66)

(shanplotdata <- shanplotmeans %>% 
  bind_cols(shanplotcontrasts))


save(shanplotdata, file='../../data/shanplotdata.RData')

```







..And table for publication
```{r shan-pub-data}
# Write to excel for pasting into publication - need to rename some of the columns etc.
shanpubdata <- 
shanplotdata %>% 
  mutate_if(is.numeric, round, 2) %>% 
  mutate(
    `Shannon diversity (H 150m-2)` = Mean,
    `EMM 95% CI`= paste(MeanLowerCI95, MeanUpperCI95, sep = '-'), 
    .before = DF, .keep = 'unused') %>% 
  mutate(
    `Pairwise contrasts` = Contrast, 
    `Contrast effect size` = Estimate,
    `Contrast 95% CI` = paste(contrastlowerCI95, contrastupperCI95, sep = '-'), 
    `Contrast 66% CI` = paste(contrastlowerCI66, contrastupperCI66, sep = '-'), 
     .keep = 'unused')

shanpubdata
write_xlsx(shanpubdata, path = "../../output/rtables/shanpubdata.xlsx")
```





