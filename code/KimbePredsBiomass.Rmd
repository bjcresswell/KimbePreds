---
title: "KimbePredsBiomass"
author: "Ben Cresswell"
date: "02/03/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

This document analyses predator fish biomass from the Kimbe Bay video survey data set. 

## Packages and housekeeping
```{r packages}
rm(list=ls())
#graphics.off()

library(gridExtra) #for plotting
library(gt)
library(lme4)      #basic model builder
library(car)       #for regression diagnostics
library(multcomp)  #for lm work
library(broom)     #for tidy output
library(ggfortify) #for model diagnostics
library(DHARMa)    #for residual diagnostics
library(performance)
library(glmmTMB)   #for wider selection of error families
library(sjPlot)    #for outputs
library(effects)   #for partial effects plots
library(ggeffects) #for partial effects plots
library(emmeans)   #for estimating marginal means
library(modelr)    #for auxillary modelling functions
library(tidyverse) #for data wrangling
```


## Data import and wrangling

Rmd setup, directory selection
```{r setup, include=FALSE, warnings=FALSE, message=FALSE}
knitr::opts_chunk$set(root.dir = "~/OneDrive - James Cook University/Ben PhD/Data & analysis/KimbePreds", echo = TRUE)
```

Load data from both survey periods (2018 and 2019) and wrangle predator sub-setted data into separate dfs called preds and predsum:
```{r diw-chunk, code = readLines(1.pred_diw.R)}
source("1.pred_diw.R", local = knitr::knit_global())
```

#####  PREDATOR ABUNDANCE  #####

# Variables:
Modelling predator abundance (response variable) against reef type (fixed effect predictor variable), with site as a random effect:

1. Numbers of predators (response variable): This is count data and needs to be scaled against total fish assemblage size, so could convert into a proportion (0-1) but instead we'll scale inside the model using offset().
2. Reef type (predictor variable (fixed effect)): Factor with 3 'levels'.
3. Site (nested random effect): 4, nested within reef type, 12 total.
4. Numbers of fish (scaling variable): Need to scale the model to account for total fish numbers

Note: Initially thought about including survey period as a fully crossed random effect, however there are only two levels within this variable making any variance partitioning meaningless (can't have variance between 2 observations - generally considered that 5 is the minimum). In theory could include as a fixed effect, however we are not really interested in it as a predictor and want to maintain model parsimony!


# Basic data exploration
Using predsum, check how the data are distributed across the different reefs and reef types
```{r abun-eda}
# Direct from script
#source("code/2.pred_abun_eda.R")
#source("code/2.pred_abun_eda.R", local = knitr::knit_global())

# Or:

# Histogram 
hist <- ggplot(predsum, aes(x=No_PredsZ)) + 
  geom_histogram(binwidth=50, color="black", fill="grey")

# Compare sites:
(predreeftypestats <- predsum %>% 
  group_by(Reeftype) %>% 
  summarise_each(funs(mean,sd,se=sd(.)/sqrt(n())), No_PredsZ))

rtbar <- ggplot(predreeftypestats, aes(x=Reeftype, y=mean))+
  geom_bar(stat="identity", position="dodge", color="black")+
  scale_y_continuous(limits = c(0,90), "Mean predator count (±SE)")+
  scale_x_discrete("Reef type and survey period")+
  labs(title="Predator abundance by reef type")+
  scale_fill_viridis_d()+
  theme_scientific()+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.2, position=position_dodge(.9))+
  theme(legend.key.size = unit(0.4, "cm"))+
  theme(plot.title = element_text(size = 14, face = "bold"),
        legend.title=element_text(size=9), 
        legend.text=element_text(size=8),
        axis.title.y = element_text(size=10, face="bold"),
        axis.title.x = element_text(size=10, face="bold"),
        axis.text = element_text(size=6))
grid.arrange(hist, rtbar, ncol=2)
```
- Lots of zeros so perhaps will need a ZI term in the model. These are count data so expecting Poisson or neg binom distributions to work best.
- Predator abundance high on pinnacles where we exclusively recorded the large schools of pelagic/semi-pelagic fishes (in particular S. qenie). Could look at transforming or adjusting the data, treating these as outliers and excluding.  However, these observations may be ecologically important and the right GLMM error-family should handle these data.  

# Fit models
Will start with basic GLMM with site as random factor. Will introduce offset later on
```{r abun-model-fit}
# Poisson
pred.glmmp <- glmmTMB(No_PredsZ~Reeftype+(1|SiteCode), data=predsum, family=poisson())

# Poisson ZI
pred.glmmpzi <- glmmTMB(No_PredsZ~Reeftype+(1|SiteCode), data=predsum, family=poisson(), ziformula=~1) 

# Neg binom 2 (Neg binom 1 poor fit)
pred.glmmnb <- glmmTMB(No_PredsZ~Reeftype+(1|SiteCode), data=predsum, family=nbinom2(link = "log"))  

#NBZI
pred.glmmzi <- glmmTMB(No_PredsZ~Reeftype+(1|SiteCode), data=predsum, family=nbinom2(), ziformula=~1)

```

# Source code for all models trialled if required (model comparisons etc)
```{r abun-model-source}
# source("3a.pred_abun_model.R", local = knitr::knit_global())
```

# Model diagnostics
```{r abun-model-diag}
p.resid <- simulateResiduals(pred.glmmp, plot=T) # 
pzi.resid <- simulateResiduals(pred.glmmpzi, plot=T) # 
nb.resid <- simulateResiduals(pred.glmmnb, plot=T) # 
zi.resid <- simulateResiduals(pred.glmmzi, plot=T)
```
-> All fail dispersion test. However nb/zi are best fit. 

# Check using binned residuals:
```{r abun-binresid}
binned_residuals(pred.glmmnb) # 100% inside error bounds
binned_residuals(pred.glmmzi) # 100% inside error bounds
```

# Validation with AIC
```{r abun-aic1}
AIC(pred.glmmnb, pred.glmmzi)
```
  df    AIC
pred.glmmnb  5 673.64
pred.glmmzi  6 675.64
-> NB model a better fit, however am interested in the ZI info

# ZI interrogation
```{r abun-zi-eda}
testZeroInflation(pred.glmmzi)
summary(pred.glmmzi)
```
# ZI test output
data:  simulationOutput
ratioObsSim = 0.76382, p-value = 0.288
alternative hypothesis: two.sided
-> Plot shows that we are actually getting slightly fewer zeros than expected and the output quantifies this: 76% of zeros expected (non significant)

# Summary output: 

Family: nbinom2  ( log )
Formula:          No_PredsZ ~ Reeftype + (1 | SiteCode)
Zero inflation:             ~1
Data: predsum

     AIC      BIC   logLik deviance df.resid 
   675.6    692.4   -331.8    663.6      114 

Random effects:

Conditional model:
 Groups   Name        Variance Std.Dev.
 SiteCode (Intercept) 0.528    0.7266  
Number of obs: 120, groups:  SiteCode, 12

Overdispersion parameter for nbinom2 family (): 1.25 

Conditional model:
                  Estimate Std. Error z value Pr(>|z|)    
(Intercept)         3.3546     0.3932   8.532  < 2e-16 ***             
ReeftypeOffshore   -2.2322     0.5618  -3.973 7.09e-05 ***
ReeftypeNearshore  -3.4045     0.5801  -5.869 4.39e-09 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

exp(3.35)

Zero-inflation model:
            Estimate Std. Error z value Pr(>|z|)
(Intercept)   -21.46    6027.21  -0.004    0.997

# So: probability of a false zero =
plogis(-21.46)= 4.8e-10 -> almost no chance that any of these zeros are false
exp(-21.46) -> and corresponding almost no odds that any zeros false either
(Makes sense if we have less zeros than expected but not sure I interpreted this right?)


#NB model interrogation
```{r abun-nb-eda}
testZeroInflation(pred.glmmnb)
emmeans(pred.glmmnb, pairwise~Reeftype, transform="response") %>% 
  confint()
```
-> So emmeans table suggests that pinnacles have more predators than both offshore emergent and near shore reefs, but that this is highly variable.  What about if we take into account overall numbers of fishes?


# Model tweaking
Now going to add the offset 
```{r abun-nb-eda}
pred.glmmnb2 <- update(pred.glmmnb, ~ . + offset(log(No_Fish)))
```


# Revalidation with AIC
```{r abun-aic2}
AIC(pred.glmmnb, pred.glmmzi, pred.glmmnb2)
```
           df      AIC
pred.glmmnb   5 673.6400
pred.glmmzi   6 675.6400
pred.glmmnb2  5 663.2228
-> Improved fit for offset model


# Check summary
```{r}
summary(pred.glmmnb2)
```
# Summary output
Family: nbinom2  ( log )
Formula:          No_PredsZ ~ Reeftype + (1 | SiteCode) + offset(log(No_Fish))
Data: predsum

     AIC      BIC   logLik deviance df.resid 
   663.2    677.2   -326.6    653.2      115 

Random effects:

Conditional model:
 Groups   Name        Variance Std.Dev.
 SiteCode (Intercept) 0.2002   0.4474  
Number of obs: 120, groups:  SiteCode, 12

Overdispersion parameter for nbinom2 family (): 1.37 

Conditional model:
                  Estimate Std. Error z value Pr(>|z|)    
(Intercept)        -2.4941     0.2661  -9.374  < 2e-16 ***
ReeftypeOffshore   -1.1511     0.3887  -2.962  0.00306 ** 
ReeftypeNearshore  -1.3150     0.4146  -3.172  0.00152 ** 
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1


# Check emmeans (transformed)
```{r abun-nb-emmeans-trans}
emmeans(pred.glmmnb2, pairwise~Reeftype, transform="response") %>% 
  confint()
```
# emmeans output
$emmeans
 Reeftype  response   SE  df lower.CL upper.CL
 Pinnacle     16.35 4.35 115     7.73    24.96
 Offshore      5.17 1.47 115     2.26     8.08
 Nearshore     4.39 1.40 115     1.62     7.16

Confidence level used: 0.95 

$contrasts
 contrast             estimate   SE  df lower.CL upper.CL
 Pinnacle - Offshore    11.177 4.59 115    0.283    22.07
 Pinnacle - Nearshore   11.959 4.57 115    1.117    22.80
 Offshore - Nearshore    0.782 2.02 115   -4.025     5.59

Confidence level used: 0.95 
Conf-level adjustment: tukey method for comparing a family of 3 estimates 

# So, taking into account overall fish abundance, pinnacles have significanly more predators on them than either offshore (11 more per 150m^2 transect) or near shore (12 more per 150m^2 transect) reefs, but this is highly variable (confints)


# Check emmeans (on log scale)
```{r abun-nb-emmeans-trans}
emmeans(pred.glmmnb2, pairwise~Reeftype) %>% 
  confint()
```
$emmeans
 Reeftype  emmean    SE  df lower.CL upper.CL
 Pinnacle    2.79 0.266 115    2.267     3.32
 Offshore    1.64 0.284 115    1.081     2.21
 Nearshore   1.48 0.318 115    0.848     2.11

Results are given on the log (not the response) scale. 
Confidence level used: 0.95 

$contrasts
 contrast             estimate    SE  df lower.CL upper.CL
 Pinnacle - Offshore     1.151 0.389 115    0.228     2.07
 Pinnacle - Nearshore    1.315 0.415 115    0.331     2.30
 Offshore - Nearshore    0.164 0.426 115   -0.848     1.18

Results are given on the log (not the response) scale. 
Confidence level used: 0.95 
Conf-level adjustment: tukey method for comparing a family of 3 estimates 

# Contrast back transformations
Pinnacle - Offshore
exp(1.151) = 3.16 -> I think this means that on average there are 3 x more predators on pinnacles than on offshore reefs
exp(0.228) = 1.26 -> Could be as little as 26% more
exp(2.07) = 7.92 -> Or as much as 7.9 times more

Pinnacle - Near shore
exp(1.315) = 3.72 -> and nearly 4 times more than on near shore reefs
exp(0.331) = 1.4 -> could be as little as 40% more
exp(2.30) = 10 -> Or as much as 10 times more


## Plots

```{r abun-plot}
emmeans(pred.glmmnb2,  ~Reeftype, transform="response") %>%
as.data.frame() %>%
   ggplot() +
   geom_pointrange(aes(y=response,  x=Reeftype,  ymin=lower.CL,  ymax=upper.CL))


```







